<script>
<%#
    // report any invalid api picture urls - url has changed or picture has been deleted
    // array with gift ids is initialized in img onload="check_api_picture_url ..."
    // submitted in 2 seconds to allow pictures in page to load
    // api_picture_url_on_error_at is set for pictures with invalid urls
    // picture urls are rechecked in gifts/index and users/show gifts tab
-%>
    setTimeout(report_missing_api_picture_urls, 2000) ;
<%#
    // end_of_page - true or false
    // true when user is near end of page (get more rows)
    // true under an active get more rows ajax request
    // is set in $(window).scroll
    // is unset in $(document).ready when new rows has been received
-%>
    // setup ajax expanding page
    var end_of_page = <%= @last_row_id ? "false" : "true" %> ;
<%#
    // check number of rows in table (gifts or users) before and after get more rows ajax event
    // do not fire any more get more rows ajax events if no new rows has been received (server side error)
-%>
    var old_number_of_rows ;
<%#
    // remember timestamp in milliseconds for last show-more-rows ajax request
    // should only request more rows once every 3 seconds
-%>
    var old_show_more_rows_request_at = 0 ;
<%#
    // ajax post processing show-row-rows. Check number of new rows. Change link for next show-more-rows ajax request
-%>
    $(document).ready(function(){
        $('#show-more-rows-link').unbind("ajax:success") ;
        $('#show-more-rows-link')
                .bind("ajax:success", function(evt, data, status, xhr){
                    show_more_rows_success("<%= show_more_rows %>", <%= debug_ajax? ? "true" : "false" %>) ;
                });
        $('#show-more-rows-link').unbind("ajax:error") ;
        $('#show-more-rows-link')
                .bind("ajax:error", function(jqxhr, textStatus, errorThrown){
                    show_more_rows_error(jqxhr, textStatus, errorThrown,<%= debug_ajax? ? "true" : "false" %>);
                });
    }); // $(document).ready
<%#
    // trigger show-more-rows event when user scrolls to end-of-page
-%>
    $(window).scroll(function(){
        show_more_rows_scroll("<%= show_more_rows %>", <%= (GET_MORE_ROWS_INTERVAL*1000).round %>,<%= debug_ajax? ? "true" : "false" %>) ;
    }); //
<%#
    // scroll to top of page after reload - prevent multiple show-more-rows requests
-%>
    $(document).ready(function(){
        $(this).scrollTop(0);
    });
<%#
    // startup with 1 row in gifts/users - get next 10 more rows
-%>
    if (!end_of_page) show_more_rows() ;
</script>