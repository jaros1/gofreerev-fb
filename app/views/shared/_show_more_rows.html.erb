<script>
<%#
    // report any invalid api picture urls - url has changed or picture has been deleted
    // array with gift ids is initialized in img onload="check_api_picture_url ..."
    // submitted in 2 seconds to allow pictures in page to load
    // api_picture_url_on_error_at is set for pictures with invalid urls
    // picture urls are rechecked in gifts/index and users/show gifts tab
-%>
    setTimeout(report_missing_api_picture_urls, 2000) ;
<%#
    // end_of_page - true or false
    // true when user is near end of page (get more rows)
    // true under an active get more rows ajax request
    // is set in $(window).scroll
    // is unset in $(document).ready when new rows has been received
-%>
    var end_of_page = <%= @last_row_id ? "false" : "true" %> ;
<%#
    // check number of rows in table (gifts or users) before and after get more rows ajax event
    // do not fire any more get more rows ajax events if no new rows has been received (server side error)
-%>
    var old_number_of_rows ;
<%#
    // remember timestamp in milliseconds for last show-more-rows ajax request
    // should only request more rows once every 3 seconds
-%>
    var old_show_more_rows_request_at = 0 ;
<%#
    // add post ajax event handler for "show-more-rows-link" link
    // change url with new last_row_id or hide url when all rows has been returned to page
    // error handling:
    //  1 - link does not longer exists - link is removed after last get more rows response
    //  2 - table with id gifts or users was not found in html page - not gifts/index, users/index or users/show pages
    //  3 - server error - ajax success but no new rows was added to gifts/users table. Must be a server error
    //  4 - invalid id format for last row returned be ajax request
-%>
    $(document).ready(function(){
        $('#show-more-rows-link')
                .bind("ajax:success", function(evt, data, status, xhr){
                    // find id for last row (nil or id for last row in table)
                    var pgm = "#show-more-rows-link.ajax:success: " ;
                    var link = document.getElementById("show-more-rows-link") ;
                    if (!link) {<% if debug_ajax? -%> add_to_debug_log(pgm + "show-more-rows-link has already been removed");<% end -%> return } // 1
                    var table = document.getElementById("<%= show_more_rows %>") ;
                    if (!table) {<% if debug_ajax? -%> add_to_debug_log(pgm + 'error - gifts or users table was not found') ;<% end -%> return } // 2
                    var new_number_of_rows = table.rows.length ;
                    if (new_number_of_rows == old_number_of_rows) {<% if debug_ajax? -%> add_to_debug_log(pgm + 'error - no new rows was returned from get more rows ajax request') ;<% end -%> return } // 3
                    var trs = table.getElementsByTagName('tr') ;
                    var tr = trs[trs.length-1] ;
                    var tr_id = tr.id ;
                    if (tr_id == "") {
                        <% if debug_ajax? -%>add_to_debug_log(pgm + 'no more rows - remove link') ; <% end -%>link.parentNode.removeChild(link);
                    }
                    else {
                        var reg = new RegExp("^last-row-id-[0-9]+$") ;
                        if (!tr_id.match(reg)) {<% if debug_ajax? -%> add_to_debug_log(pgm + 'row with format last-row-id-<n> was not found. id = ' + tr_id);<% end -%> return } // 4
                        var tr_id_a = tr_id.split("-") ;
                        var last_row_id = tr_id_a[tr_id_a.length-1] ;
                        var href = link.href ;
                        href = href.replace(/last_row_id=[0-9]+/, 'last_row_id=' + last_row_id) ;
                        link.href = href ;
                        end_of_page = false ;
                    }
                });
    }); // $(document).ready

    // check if user scrolls to end of page and get more gifts from server before user reaches end of page
    $(window).scroll(function(){
        if (end_of_page) return ;
        if (($(document).height() - $(window).height()) - $(window).scrollTop() < 600){
            end_of_page = true ;
            if (!document.getElementById("show-more-rows-link")) return ;
            var table = document.getElementById("<%= show_more_rows %>") ;
            if (!table) return ;
            old_number_of_rows = table.rows.length ;
            var now = (new Date()).getTime();
<%#
  There is a minor problem with wait between show-more-rows request
  Implemented here and implemented in get_next_set_of_rows_error? and get_next_set_of_rows methods in application controller
  For now the check is for 3 seconds in javascript and for 2 seconds in rails
-%>
            var sleep = <%= (GET_MORE_ROWS_INTERVAL*1000).round %> - (now-old_show_more_rows_request_at) ;
            if (sleep < 0) sleep = 0 ;
<% if debug_ajax? -%>
            add_to_debug_log('Sleep ' + (sleep/1000.0) + ' seconds' + '. old timestamp ' + old_show_more_rows_request_at + ', new timestamp ' + now) ;
<% end -%>
            old_show_more_rows_request_at = now + sleep ;
            if (sleep == 0) show_more_rows() ;
            else setTimeout("show_more_rows()",sleep) ;
<%#
            // report any invalid api picture urls - url has changed or picture has been deleted
            // array with gift ids is initialized in img onload="check_api_picture_url ..."
            // submitted in 2 seconds to allow pictures in page to load
            // api_picture_url_on_error_at is set for pictures with invalid urls
            // picture urls are checked with api calls by current user and if necessary by picture owner at a later time
-%>
            setTimeout(report_missing_api_picture_urls, 2000) ;
        }
    }); //
<%#
    // scroll to top of page after reload - only fetch newest 10 gifts after reload
-%>
    $(document).ready(function(){
        $(this).scrollTop(0);
    });

</script>