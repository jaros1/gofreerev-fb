<script>



    function new_messages_count ()
  {
      js = '<div id=\"new_messages_count_div\"><\/div>\n<div id=\"new_comments_div\">\n  <table>\n    <tbody id=\"new_comments_tbody\">\n      \n    <\/tbody>\n  <\/table>\n<\/div>\n<div id=\"new_gifts_div\">\n  <input id=\"new-newest-gift-id\" name=\"new_newest_gift_id\" type=\"hidden\" value=\"241\" />\n  <table>\n    <tbody id=\"new_gifts_tbody\">\n    \n    <tr style=\"vertical-align: top\" id=\"gift-240-header\">\n  <td>\n        <div title=\"Sandra Q. Saldo -4,96 (-47,77 DKK, 49,76 SEK, -0,08 USD). Klik her for at se brugeroplysninger.\"\n     onclick=\"top.location.href = \'/users/13\'\">\n  <img src=\"/images/profiles/bb/69/4b/ce/ad/b1/1c/46/0a/c9/34/97/b8/82/b2/fc/0evx0f.jpg\" />\n<\/div>\n  <\/td>\n  <td>\n  <\/td>\n  <td colspan=\"2\" style=\"height: 52px; vertical-align: top\">\n    <a href=\"/gifts/240\" title=\"Klik på link for flere informationer om opslag\">22. sep 2013, 10.39  / Sandra Q tilbyder<\/a>\n     : hello charlie xxxx\n  <\/td>\n<\/tr>\n\n\n<tr id=\'gift-240-links\'>\n  <td colspan=\"2\"><\/td>\n  <td colspan=\"2\">\n    <a data-method=\"post\" data-remote=\"true\" href=\"/util/like_gift?gift_id=240\" id=\"gift-240-like-unlike-link\" rel=\"nofollow\">Synes om<\/a>\n    - <a data-method=\"post\" data-remote=\"true\" href=\"/util/follow_gift?gift_id=240\" id=\"gift-240-follow-unfollow-link\" rel=\"nofollow\">Følg opslag<\/a>\n        - <a data-confirm=\"Skjul opslag?\" data-method=\"post\" data-remote=\"true\" href=\"/util/hide_gift?gift_id=240\" id=\"gift-240-hide-link\" rel=\"nofollow\">Skjul opslag<\/a>\n  <\/td>\n<\/tr>\n    <tr id=\"gift-240-comment-452\">\n  <td colspan=\"2\"><\/td>\n  <td style=\"vertical-align: top;\"><div title=\"Sandra Q. Saldo -4,96 (-47,77 DKK, 49,76 SEK, -0,08 USD). Klik her for at se brugeroplysninger.\"\n     onclick=\"top.location.href = \'/users/13\'\">\n  <img src=\"/images/profiles/bb/69/4b/ce/ad/b1/1c/46/0a/c9/34/97/b8/82/b2/fc/0evx0f.jpg\" />\n<\/div><\/td>\n  <td>ggg<\/td>\n<\/tr>\n\n\n\n<tr id=\'gift-240-add-new-comment-row\'>\n  <td colspan=\"2\" style=\"text-align: right; vertical-align: top\">\n        <table>\n          <tr>\n            <td>Foreslå aftale<\/td>\n            <td><input id=\"gift-240-new-deal-check-box\" name=\"gift-240-new-deal-check-box\" onclick=\"check_uncheck_new_deal_checkbox(this,240)\" type=\"checkbox\" value=\"x\" /><\/td>\n          <\/tr>\n        <\/table>\n  <\/td>\n  <td style=\"vertical-align: top;\"><div title=\"Charlie S. Saldo . Klik her for at se brugeroplysninger.\"\n     onclick=\"top.location.href = \'/users/458\'\">\n  <img src=\"/images/profiles/87/c3/db/bc/37/b3/15/89/ac/77/a9/78/8d/95/e1/da/x410pk.jpg\" />\n<\/div><\/td>\n  <td>\n    <form accept-charset=\"UTF-8\" action=\"/comments\" class=\"new_comment\" data-remote=\"true\" id=\"gift-240-new-comment-form\" method=\"post\"><div style=\"margin:0;padding:0;display:inline\"><input name=\"utf8\" type=\"hidden\" value=\"&#x2713;\" /><\/div>\n        <input id=\"gift-240-comment-gift-id\" name=\"comment[gift_id]\" type=\"hidden\" value=\"4TAvykXj1ZEyUpAon8VS\" />\n        <input id=\"gift-240-comment-new-deal-yn\" name=\"comment[new_deal_yn]\" type=\"hidden\" />\n\n        <table style=\"border-spacing: 0;\">\n          <tr id=\"gift-240-new-comment-price-tr\" style=\"display: none\">\n            <td colspan=\"2\">\n              <input id=\"gift-240-comment-price\" name=\"comment[price]\" placeholder=\"Pris\" size=\"10\" type=\"text\" />\n              frie DKK\n            <\/td>\n          <\/tr>\n          <tr>\n            <td><textarea cols=\"60\" id=\"gift-240-new-comment-textarea\" name=\"comment[comment]\" onfocus=\"autoresize_text_field(this)\" placeholder=\"Skriv en kommentar...\" rows=\"1\">\n<\/textarea><\/td>\n            <td><input name=\"commit\" onclick=\"return csv_comment(240)\" type=\"submit\" value=\"Gem\" /><\/td>\n          <\/tr>\n        <\/table>\n<\/form>  <\/td>\n<\/tr>\n\n<tr id=\"gift-240-row-3\">\n  <td colspan=\"4\">&nbsp;<\/td>\n<\/tr>\n    <tr id=\"gift-240-row-4\">\n      <td colspan=\"4\">&nbsp;<\/td>\n    <\/tr>\n\n\n    <\/tbody>\n  <\/table>\n<\/div>\n' ;
      document.getElementById('new_messages_buffer_div').innerHTML = js ;
      update_new_messages_count() ;
      update_title();
      insert_new_comments() ;
      insert_new_gifts() ;
      alert("new_messages_count") ;
  } // new_messages_count
</script>

<%= link_to "new-messages-count", "javascript:new_messages_count()" %>


<%= hidden_field_tag :newest_gift_id, @newest_gift_id, :id => "newest-gift-id" %>

<script>
  last_user_ajax_comment_at = null ;
<%=
  # recheck invalid picture urls with owner permissions
  @missing_api_picture_urls
%>
</script>

<% #noinspection RubyResolve
   if !@user -%>
    <p>
      <%= my_t '.not_logged_in_text' %>
    </p>
<% else -%>
    <% if !@user.post_gift_allowed? -%>
        <p title="<%= my_t '.post_gift_not_allowed_title', :appname => APP_NAME, :apiname => @user.api_name_without_brackets %>">
          <%= my_t '.post_gift_not_allowed_text', :appname => APP_NAME, :apiname => @user.api_name_without_brackets %><br />
          <%= link_to my_t('.request_post_gift_priv_link_text', :appname => APP_NAME), "javascript: {top.location.href='#{auth_post_gift_url}'}" %>
        </p>
    <% elsif flash[:read_stream] -%>
        <p title="<%= my_t '.read_stream_not_allowed_title', :appname => APP_NAME, :apiname => @user.api_name_without_brackets %>">
          <%= my_t '.read_stream_not_allowed_text', :appname => APP_NAME, :apiname => @user.api_name_without_brackets %><br />
          <%= link_to my_t('.request_read_stream_priv_link_text', :appname => APP_NAME), "javascript: {top.location.href='#{auth_read_stream_url}'}" %>
        </p>
    <% end -%>
    <%= form_for @gift, :multipart => true, :html => { :enctype => 'multipart/form-data' } do |f| %>
        <table>
          <tr>
            <td colspan="3"><%= my_t '.create_gift_header_line' %></td>
          </tr>
          <tr title="<%= my_t '.price_title' %>">
            <td><%= my_t '.price_prompt' %></td>
            <td colspan="2">
              <%= f.text_field(:price, :size=>10, :maxlength=>10) %>
              <%= my_t '.price_free' %>
              <%= @user.currency %>
              &nbsp;&nbsp;&nbsp;
              <%= my_t '.direction_giver_prompt' %> <%= f.radio_button :direction, 'giver' %>
              <%= my_t '.direction_receiver_prompt' %> <%= f.radio_button :direction, 'receiver' %>
            </td>
          </tr>
          <tr title="<%= my_t '.description_title' %>">
            <td style="vertical-align: top"><%= my_t '.description_prompt' %></td>
            <td><%= f.text_area :description, :size => '60x2', :placeholder => 'Enter Comments', :onfocus => 'autoresize_text_field(this)' %></td>
            <td><%= f.submit my_t('.gift_submit_button_text'), :onclick => '{return csv_gift()}' %></td>
          </tr>
          <tr title="<%= my_t ".file_title_#{@user.post_gift_allowed?}", :appname => APP_NAME, :apiname => @user.api_name_without_brackets %>">
            <td><%= my_t '.file_prompt' %></td>
            <td colspan="2"><%= file_field_tag(:gift_file, :disabled => !@user.post_gift_allowed?) %></td>
          </tr>
        </table>
    <% end %>
<% end -%>

<% if @gifts.size == 0 -%>
    <p>
      <%= my_t '.no_gifts_was_found' %>
    </p>
<% else -%>
    <br />
    <table id="gifts" style="border-spacing: 0;">
      <%= render :partial => 'table_header_row' %>
      <%= render :partial => 'gifts' %>
    </table>
    <%# will_paginate @gifts %>
<% end -%>

<br />
<br />
<%= link_to "add-more-lines", "/gifts?last_gift_id=#{@last_gift_id}", :remote => true, :id => "show-more-gifts-link", :style => "display: none" %>

<script>
    // add page specific version of pre_update_currency function.
    // That is confirm popup before leaving page with unsaved data.
    pending_gift_msg = '<%= my_t '.pending_gift_popup_msg' %>' ;
    pre_update_currency = gifts_pre_update_currency ;

    // Translate texts used in client side validations.
    csv_gift_description_required = '<%= my_t '.description_required_text' %>' ;
    csv_gift_price_invalid = '<%= my_t '.price_invalid_text' %>' ;
    csv_comment_comment_required = '<%= my_t '.comment_comment_required_text' %>' ;
    csv_comment_price_invalid = '<%= my_t '.comment_price_invalid_text' %>' ;


    // report any invalid api picture urls - url has changed or picture has been deleted
    // array with gift ids is initialized in img onload="check_api_picture_url ..."
    // submitted in 2 seconds to allow pictures in page to load
    // api_picture_url_on_error_at is setted for pictures with invalid urls
    setTimeout(report_missing_api_picture_urls, 2000) ;

    // true when user is near end of page (get more gifts)
    var bottcsv_gifts_price_invalidom = false ;

    // add post ajax event handler for "show-more-gifts-link" link
    // change url with new last_gift_id or hide url when all gifts has been returned to page
    $(document).ready(function(){
        $('#show-more-gifts-link')
                .bind("ajax:success", function(evt, data, status, xhr){
                    // find id for last gift (nil or gift_id for last gift in table)
                    var link = document.getElementById("show-more-gifts-link") ;
                    if (!link) return ; // link has already been removed
                    var table = document.getElementById("gifts") ;
                    var trs = table.getElementsByTagName('tr') ;
                    var tr = trs[trs.length-1] ;
                    var tr_id = tr.id ;
                    // alert('tr_id = ' + tr_id) ;
                    if (tr_id == "") {
                      // alert('no more gifts - remove link') ;
                      link.parentNode.removeChild(link);
                      // todo: remove this event handler
                    }
                    else {
                      // change last_gift_id in link
                      var tr_id_a = tr_id.split("_") ;
                      var last_gift_id = tr_id_a[tr_id_a.length-1] ;
                      // alert('last_gift_id = ' + last_gift_id) ;
                      link.href = "/gifts?last_gift_id=" + last_gift_id ;
                      bottom = false ;
                    }
                });
    }); // $(document).ready

    // check if user scrolls to end of page and get more gifts from server before user reaches end of page
    $(window).scroll(function(){
        if (bottom) return ;
        if (($(document).height() - $(window).height()) - $(window).scrollTop() < 600){
            bottom = true ;
            // alert("We're at the bottom of the page!!");
            var link = document.getElementById("show-more-gifts-link") ;
            if (!link) return ; // no more gifts - unregister this function
            // get more gifts from server
            link.click() ;
            // report any invalid api picture urls - url has changed or picture has been deleted
            // array with gift ids is initialized in img onload="check_api_picture_url ..."
            // submitted in 2 seconds to allow pictures in page to load
            // api_picture_url_on_error_at is set for pictures with invalid urls
            // picture urls are checked with api calls by current user and if necessary by picture owner at a later time
            setTimeout(report_missing_api_picture_urls, 2000) ;
        }
    }); // $(window).scroll

    // scroll to top of page after reload - only fetch newest 10 gifts after reload
    $(document).ready(function(){
        $(this).scrollTop(0);
    });

</script>

